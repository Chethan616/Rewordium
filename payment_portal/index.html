<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rewordium Pro - Payment Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .dashboard-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .logo p {
            color: #666;
            font-size: 14px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 30px;
        }
        
        .tab-button {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button:first-child {
            border-radius: 5px 0 0 5px;
        }
        
        .tab-button:last-child {
            border-radius: 0 5px 5px 0;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102,126,234,0.3);
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-google {
            background: #db4437;
            color: white;
        }
        
        .btn-google:hover {
            background: #c23321;
        }
        
        .btn-upgrade {
            background: #28a745;
            color: white;
            font-weight: bold;
        }
        
        .btn-upgrade:hover {
            background: #218838;
        }
        
        .btn-upgrade:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-popular {
            background: #fd7e14;
        }
        
        .btn-popular:hover {
            background: #e56b00;
        }
        
        .error {
            color: #dc3545;
            margin-top: 10px;
            text-align: center;
        }
        
        .success {
            color: #28a745;
            margin-top: 10px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        .user-info {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .status.free {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.pro {
            background: #d4edda;
            color: #155724;
        }
        
        .pricing-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pricing-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .pricing-card.popular {
            border-color: #fd7e14;
            position: relative;
        }
        
        .popular-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #fd7e14;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .plan-header h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .price span {
            font-size: 14px;
            color: #666;
        }
        
        .plan-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .savings {
            color: #28a745;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .features {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .features li {
            padding: 5px 0;
            color: #666;
            position: relative;
            padding-left: 20px;
        }
        
        .features li:before {
            content: "‚úì";
            color: #28a745;
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        .payment-status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .payment-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .payment-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .payment-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102,126,234,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
            <div style="font-size: 24px; margin-bottom: 20px;">üöÄ Loading Payment Portal</div>
            <div id="loadingStatus" style="font-size: 14px;">Initializing...</div>
        </div>
    </div>

    <!-- Authentication Section -->
    <div id="authSection" class="container">
        <div class="logo">
            <h1>Rewordium Pro</h1>
            <p>Upgrade to Premium Features</p>
        </div>
        
        <div class="tab-buttons">
            <div class="tab-button active" onclick="switchTab('signin')">Sign In</div>
            <div class="tab-button" onclick="switchTab('signup')">Sign Up</div>
        </div>
        
        <!-- Sign In Form -->
        <form id="signinForm">
            <div class="form-group">
                <label for="signinEmail">Email</label>
                <input type="email" id="signinEmail" required>
            </div>
            <div class="form-group">
                <label for="signinPassword">Password</label>
                <input type="password" id="signinPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Sign In</button>
        </form>
        
        <!-- Sign Up Form -->
        <form id="signupForm" class="hidden">
            <div class="form-group">
                <label for="signupName">Full Name</label>
                <input type="text" id="signupName" required>
            </div>
            <div class="form-group">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" required>
            </div>
            <div class="form-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Sign Up</button>
        </form>
        
        <button class="btn btn-google" onclick="signInWithGoogle()">Continue with Google</button>
        <div id="authError" class="error"></div>
    </div>
    
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard-container hidden">
        <div class="user-info">
            <h2 id="userName">Welcome!</h2>
            <p id="userEmail"></p>
            <div id="userStatus" class="status free">Free Plan</div>
            <button onclick="refreshSubscriptionStatus()" style="margin: 5px 5px 0 0; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">üîÑ Refresh Status</button>
            <button onclick="signOut()" class="btn-signout" style="margin-top: 5px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Sign Out</button>
        </div>
        
        <!-- Payment Status -->
        <div id="paymentStatus" class="payment-status hidden">
            <div id="paymentStatusText">Processing...</div>
        </div>
        
        <div id="upgradeSection">
            <h3 style="text-align: center; margin-bottom: 20px;">Choose Your Plan</h3>
            
            <!-- Test Instructions -->
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 14px;">
                <strong>üß™ Testing Instructions:</strong><br>
                <strong>For Indian Cards:</strong> 4111 1111 1111 1111, CVV: 123, Exp: 12/25<br>
                <strong>For Net Banking:</strong> Select any bank and use demo credentials<br>
                <strong>For UPI:</strong> Use success@razorpay as UPI ID<br>
                <em>Note: International cards may not work in test mode</em>
            </div>
            
            <div class="pricing-plans">
                <!-- Monthly Plan -->
                <div class="pricing-card">
                    <div class="plan-header">
                        <h4>Monthly Pro</h4>
                        <div class="price">$1.49<span>/month</span></div>
                        <p class="plan-desc">Perfect for trying premium features</p>
                    </div>
                    <ul class="features">
                        <li>Unlimited AI rewrites</li>
                        <li>Advanced grammar checking</li>
                        <li>Premium templates</li>
                        <li>Priority support</li>
                        <li>No ads</li>
                    </ul>
                    <button class="btn btn-upgrade" data-plan="monthly" data-price="1.49" id="monthlyBtn">
                        Choose Monthly - $1.49
                    </button>
                </div>
                
                <!-- Yearly Plan -->
                <div class="pricing-card popular">
                    <div class="popular-badge">Most Popular</div>
                    <div class="plan-header">
                        <h4>Yearly Pro</h4>
                        <div class="price">$5.49<span>/year</span></div>
                        <p class="plan-desc">Save 69% with annual billing</p>
                        <p class="savings">Save $12.39 per year!</p>
                    </div>
                    <ul class="features">
                        <li>Everything in Monthly</li>
                        <li>Priority customer support</li>
                        <li>Early access to new features</li>
                        <li>Export to multiple formats</li>
                        <li>Team collaboration tools</li>
                    </ul>
                    <button class="btn btn-upgrade btn-popular" data-plan="yearly" data-price="5.49" id="yearlyBtn">
                        Choose Yearly - $5.49
                    </button>
                </div>
                
                <!-- Lifetime Plan -->
                <div class="pricing-card">
                    <div class="plan-header">
                        <h4>Lifetime Pro</h4>
                        <div class="price">$9.99<span>/lifetime</span></div>
                        <p class="plan-desc">One payment, forever access</p>
                    </div>
                    <ul class="features">
                        <li>Everything in Yearly</li>
                        <li>Lifetime updates</li>
                        <li>No recurring payments</li>
                        <li>Premium customer support</li>
                        <li>All future features included</li>
                    </ul>
                    <button class="btn btn-upgrade" data-plan="onetime" data-price="9.99" id="lifetimeBtn">
                        Choose Lifetime - $9.99
                    </button>
                </div>
            </div>
        </div>
        
        <div id="proSection" class="hidden">
            <div class="status pro">Pro Plan Active</div>
            <p style="text-align: center; color: #666;">You have unlimited access to all premium features!</p>
        </div>
        
        <button class="btn" onclick="signOut()" style="background: #6c757d; color: white; margin-top: 20px;">Sign Out</button>
        <div id="dashboardError" class="error"></div>
        <div id="dashboardSuccess" class="success"></div>
    </div>

    <!-- Scripts -->
    <script>
        console.log('üöÄ Production Payment Portal Loading...');
        
        // Global variables
        let currentUser = null;
        let scriptsLoaded = 0;
        const totalScripts = 2; // Razorpay + Firebase
        
        // Configuration
        const RAZORPAY_KEY = 'rzp_test_jO7w6q41ABzOj7';
        const EXCHANGE_RATE = 83;
        
        // Firebase Configuration - Using Rewordium project
        const firebaseConfig = {
            apiKey: "AIzaSyBoG1w3GaQVy2O6kjp-ZQw09TZgbUWjrTg",
            authDomain: "rewordium.firebaseapp.com",
            projectId: "rewordium",
            storageBucket: "rewordium.firebasestorage.app",
            messagingSenderId: "1046215732414",
            appId: "1:1046215732414:android:a97ddde5e4953c46ab02ef"
        };
        
        // Global Firebase variables
        let db = null;
        let auth = null;
        
        // Test card numbers that work with Razorpay
        const TEST_CARDS = {
            success: '4111111111111111',
            successRupay: '6521111111111111',
            successMaster: '5555555555554444',
            decline: '4000000000000002'
        };
        
        // Update loading status
        function updateLoadingStatus(message) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
            console.log('üì¶ ' + message);
        }
        
        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    if (firebase.apps.length === 0) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.firestore();
                    auth = firebase.auth();
                    console.log('‚úÖ Firebase initialized successfully');
                    console.log('üîó Connected to project:', firebaseConfig.projectId);
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è Firebase SDK not loaded - running in demo mode');
                    return false;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase initialization failed:', error.message);
                console.warn('üîß Check Firebase configuration and internet connection');
                return false;
            }
        }
        
        // Save payment to Firebase
        async function savePaymentToFirebase(paymentData) {
            console.log('üîç Checking Firebase connection...');
            console.log('üîó Database object:', !!db);
            console.log('üîó Firebase available:', typeof firebase !== 'undefined');
            
            if (!db) {
                console.log('üìù Demo mode - Payment would be saved:', paymentData);
                return { success: true, demo: true };
            }
            
            try {
                console.log('üíæ Attempting to save payment to Firebase...');
                
                const docRef = await db.collection('payments').add({
                    ...paymentData,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                });
                
                console.log('‚úÖ Payment saved to Firebase:', docRef.id);
                
                // Also update user's subscription status and isPro flag
                if (currentUser && currentUser.uid) {
                    console.log('üë§ Updating user subscription for:', currentUser.uid);
                    
                    // Prepare the update data structure to match Flutter expectations
                    const updateData = {
                        isPro: true, // ‚úÖ Set user as Pro
                        planType: paymentData.planType, // ‚úÖ Set planType for Flutter compatibility
                        subscription: {
                            planType: paymentData.planType, // ‚úÖ Match Flutter auth_provider structure
                            plan: paymentData.planType, // Keep both for compatibility
                            status: 'active',
                            paymentId: paymentData.paymentId,
                            amount: paymentData.amountUSD,
                            currency: 'USD',
                            startDate: firebase.firestore.FieldValue.serverTimestamp(),
                            expiryDate: calculateExpiryDate(paymentData.planType)
                        },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    console.log('üìù Update data prepared:', updateData);
                    
                    await db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });
                    
                    console.log('‚úÖ User subscription updated - isPro: true, planType:', paymentData.planType);
                } else {
                    console.warn('‚ö†Ô∏è No current user - cannot update subscription');
                }
                
                return { success: true, docId: docRef.id };
            } catch (error) {
                console.error('‚ùå Failed to save payment to Firebase:', error);
                console.error('üîß Error details:', error.code, error.message);
                return { success: false, error: error.message };
            }
        }
        
        // Calculate subscription expiry date
        function calculateExpiryDate(planType) {
            const now = new Date();
            if (planType === 'monthly') {
                now.setMonth(now.getMonth() + 1);
                return firebase.firestore.Timestamp.fromDate(now);
            } else if (planType === 'yearly') {
                now.setFullYear(now.getFullYear() + 1);
                return firebase.firestore.Timestamp.fromDate(now);
            } else if (planType === 'onetime') {
                // Lifetime - set to 100 years from now (or return null for no expiry)
                now.setFullYear(now.getFullYear() + 100);
                return firebase.firestore.Timestamp.fromDate(now);
            }
            return firebase.firestore.Timestamp.fromDate(now);
        }
        
        // Check if user should have Pro status based on subscription
        function shouldUserBePro(subscriptionData) {
            if (!subscriptionData || !subscriptionData.subscription) {
                return false;
            }
            
            const subscription = subscriptionData.subscription;
            
            // Check if subscription is active
            if (subscription.status !== 'active') {
                return false;
            }
            
            // Check expiry date
            if (subscription.expiryDate) {
                const expiryDate = subscription.expiryDate.toDate();
                const now = new Date();
                
                if (now > expiryDate) {
                    console.log('‚ö†Ô∏è Subscription expired, should update isPro to false');
                    return false;
                }
            }
            
            return true;
        }
        
        // Update user's Pro status based on subscription validity
        async function updateUserProStatus(userId, isPro) {
            if (!db) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    isPro: isPro,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`‚úÖ User isPro status updated to: ${isPro}`);
            } catch (error) {
                console.error('‚ùå Failed to update isPro status:', error);
            }
        }
        
        // Handle expired subscription (similar to Flutter auth_provider.dart)
        async function handleExpiredSubscription(userId) {
            if (!db) return;
            
            try {
                await db.collection('users').doc(userId).update({
                    isPro: false,
                    planType: 'free',
                    credits: 20, // Reset to free credits (matching Firebase service)
                    'subscription.status': 'expired',
                    expiredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('üîÑ Pro status revoked due to subscription expiration');
            } catch (error) {
                console.error('‚ùå Error handling expired subscription:', error);
            }
        }
        
        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    // Always start with authentication - don't bypass auth
                    showAuth();
                }, 500);
            }
        }
        
        // Show authentication section
        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
        }
        
        // Show dashboard section
        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            // User info will be set by auth state listener - no demo data
            console.log('‚úÖ Dashboard shown for authenticated user');
        }
        
        // Tab switching
        function switchTab(tab) {
            const signinForm = document.getElementById('signinForm');
            const signupForm = document.getElementById('signupForm');
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'signin') {
                tabButtons[0].classList.add('active');
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                tabButtons[1].classList.add('active');
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            }
        }
        
        // Payment status management
        function showPaymentStatus(status, message) {
            const paymentStatus = document.getElementById('paymentStatus');
            
            paymentStatus.className = `payment-status payment-${status}`;
            paymentStatus.textContent = message;
            paymentStatus.classList.remove('hidden');
            
            console.log(`[${status.toUpperCase()}] ${message}`);
            
            if (status !== 'loading') {
                setTimeout(() => {
                    paymentStatus.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Handle payment
        function handlePayment(planType, priceUSD, button) {
            console.log('üí≥ Payment initiated:', { planType, priceUSD });
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';
            
            showPaymentStatus('loading', 'Preparing payment...');
            
            // Check if Razorpay is available
            if (typeof Razorpay === 'undefined') {
                showPaymentStatus('error', 'Payment system not available. Please refresh and try again.');
                resetButton(button, originalText);
                return;
            }
            
            // Convert to INR
            const amountInPaise = Math.round(priceUSD * EXCHANGE_RATE * 100);
            const displayINR = (priceUSD * EXCHANGE_RATE).toFixed(2);
            
            const planNames = {
                'monthly': 'Monthly Pro',
                'yearly': 'Yearly Pro',
                'onetime': 'Lifetime Pro'
            };
            
            const options = {
                key: RAZORPAY_KEY,
                amount: amountInPaise,
                currency: 'INR',
                name: 'Rewordium',
                description: `${planNames[planType]} Subscription`,
                image: 'https://cdn-icons-png.flaticon.com/512/1006/1006555.png',
                order_id: '', // Leave empty for test mode
                handler: function (response) {
                    handlePaymentSuccess(response, planType, priceUSD, button);
                },
                prefill: {
                    name: 'Test User',
                    email: 'test@rewordium.com',
                    contact: '9999999999'
                },
                notes: {
                    address: 'Test Address',
                    merchant_order_id: `rewordium_${planType}_${Date.now()}`
                },
                theme: {
                    color: '#667eea'
                },
                config: {
                    display: {
                        blocks: {
                            card: {
                                name: 'Pay with Card',
                                instruments: [
                                    {
                                        method: 'card'
                                    }
                                ]
                            },
                            netbanking: {
                                name: 'Pay via Net Banking',
                                instruments: [
                                    {
                                        method: 'netbanking'
                                    }
                                ]
                            },
                            wallet: {
                                name: 'Pay via Wallet',
                                instruments: [
                                    {
                                        method: 'wallet'
                                    }
                                ]
                            }
                        },
                        sequence: ['block.card', 'block.netbanking', 'block.wallet'],
                        preferences: {
                            show_default_blocks: true
                        }
                    }
                },
                modal: {
                    ondismiss: function() {
                        showPaymentStatus('error', 'Payment cancelled by user');
                        resetButton(button, originalText);
                    },
                    escape: true,
                    backdropclose: false
                }
            };
            
            const rzp = new Razorpay(options);
            
            rzp.on('payment.failed', function (response) {
                console.error('Payment failed:', response);
                let errorMessage = 'Payment failed. Please try again.';
                
                // Handle specific error cases
                if (response.error) {
                    if (response.error.code === 'BAD_REQUEST_ERROR' && 
                        response.error.description.includes('international')) {
                        errorMessage = 'International cards not supported. Try Indian test cards or Net Banking.';
                    } else if (response.error.code === 'GATEWAY_ERROR') {
                        errorMessage = 'Payment gateway error. Please try a different payment method.';
                    } else if (response.error.description) {
                        errorMessage = response.error.description;
                    }
                }
                
                showPaymentStatus('error', errorMessage);
                resetButton(button, originalText);
            });
            
            showPaymentStatus('loading', 'Opening payment gateway...');
            rzp.open();
        }
        
        function handlePaymentSuccess(response, planType, priceUSD, button) {
            const planNames = {
                'monthly': 'Monthly Pro',
                'yearly': 'Yearly Pro',
                'onetime': 'Lifetime Pro'
            };
            
            // Prepare payment data for Firebase
            const paymentData = {
                paymentId: response.razorpay_payment_id,
                planType: planType,
                planName: planNames[planType],
                amountUSD: priceUSD,
                amountINR: (priceUSD * EXCHANGE_RATE).toFixed(2),
                currency: 'INR',
                paymentMethod: 'razorpay',
                userEmail: currentUser ? currentUser.email : 'user@rewordium.com',
                userId: currentUser ? currentUser.uid : 'demo_user',
                razorpaySignature: response.razorpay_signature || null
            };
            
            showPaymentStatus('success', `Payment successful! Saving to database...`);
            
            // Save to Firebase
            savePaymentToFirebase(paymentData).then(result => {
                if (result.success) {
                    if (result.demo) {
                        showPaymentStatus('success', `üéâ Payment successful! Welcome to ${planNames[planType]}! (Demo Mode)`);
                    } else {
                        showPaymentStatus('success', `üéâ Payment successful! Welcome to ${planNames[planType]}! Data saved to Firebase.`);
                    }
                    
                    // Update UI to show Pro status
                    updateUIToPro(planNames[planType]);
                    
                } else {
                    showPaymentStatus('success', `üéâ Payment successful! Welcome to ${planNames[planType]}! (Database save failed: ${result.error})`);
                }
                
                button.textContent = '‚úÖ Payment Complete';
                button.style.background = '#28a745';
                
                console.log('üéâ Payment completed and processed:', {
                    planType,
                    priceUSD,
                    paymentId: response.razorpay_payment_id,
                    firebaseResult: result,
                    isPro: true
                });
            }).catch(error => {
                console.error('Payment save error:', error);
                showPaymentStatus('success', `üéâ Payment successful! Welcome to ${planNames[planType]}! (Database connection issue)`);
                button.textContent = '‚úÖ Payment Complete';
                button.style.background = '#28a745';
            });
        }
        
        function resetButton(button, originalText) {
            button.disabled = false;
            button.textContent = originalText;
        }
        
        // Update UI to show Pro status after successful payment
        function updateUIToPro(planName) {
            // Use the new unified function
            setUIToProUser(planName);
            console.log('‚úÖ UI updated to show Pro status after payment');
        }
        
        // Set up payment handlers
        function setupPaymentHandlers() {
            const buttons = document.querySelectorAll('.btn-upgrade');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const planType = this.getAttribute('data-plan');
                    const priceUSD = parseFloat(this.getAttribute('data-price'));
                    handlePayment(planType, priceUSD, this);
                });
            });
            console.log('‚úÖ Payment handlers ready');
        }
        
        // Set up authentication form handlers
        function setupAuthHandlers() {
            const signinForm = document.getElementById('signinForm');
            const signupForm = document.getElementById('signupForm');
            
            if (signinForm) {
                signinForm.addEventListener('submit', handleSignIn);
            }
            
            if (signupForm) {
                signupForm.addEventListener('submit', handleSignUp);
            }
            
            console.log('‚úÖ Auth handlers ready');
        }
        
        // Listen for authentication state changes
        function setupAuthStateListener() {
            if (auth) {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üîÑ User authenticated:', user.uid);
                        currentUser = user;
                        
                        // Update UI with user info
                        document.getElementById('userName').textContent = `Welcome, ${user.displayName || user.email || 'User'}!`;
                        document.getElementById('userEmail').textContent = user.email || '';
                        
                        // Check user's subscription status from Firebase
                        await checkUserSubscriptionStatus(user.uid);
                        
                        showDashboard();
                    } else {
                        console.log('üîÑ User signed out');
                        currentUser = null;
                        showAuth();
                    }
                });
                console.log('‚úÖ Auth state listener ready');
            }
        }
        
        // Check user's subscription status from Firebase
        async function checkUserSubscriptionStatus(userId) {
            if (!db || !userId) {
                console.log('‚ö†Ô∏è Cannot check subscription - no database or user ID');
                setUIToFreeUser();
                return;
            }
            
            try {
                console.log('üîç Checking subscription status for user:', userId);
                
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    console.log('‚ö†Ô∏è User document not found - showing as free user');
                    setUIToFreeUser();
                    return;
                }
                
                const userData = userDoc.data();
                console.log('üìÑ User data retrieved:', userData);
                
                // Check if user is Pro and has valid subscription
                if (userData.isPro && userData.subscription) {
                    const subscription = userData.subscription;
                    
                    // Check if subscription is active and not expired
                    if (subscription.status === 'active' && subscription.expiryDate) {
                        const expiryDate = subscription.expiryDate.toDate();
                        const now = new Date();
                        
                        if (now <= expiryDate) {
                            // Subscription is valid - show as Pro user
                            const planNames = {
                                'monthly': 'Monthly Pro',
                                'yearly': 'Yearly Pro', 
                                'onetime': 'Lifetime Pro'
                            };
                            
                            const planName = planNames[subscription.planType] || subscription.planType || 'Pro';
                            console.log('‚úÖ Valid subscription found:', planName);
                            setUIToProUser(planName);
                            return;
                        } else {
                            // Subscription expired - update status
                            console.log('‚ö†Ô∏è Subscription expired on:', expiryDate);
                            await handleExpiredSubscription(userId);
                        }
                    } else if (subscription.planType === 'onetime') {
                        // Lifetime subscription - always valid
                        console.log('‚úÖ Lifetime subscription found');
                        setUIToProUser('Lifetime Pro');
                        return;
                    }
                }
                
                // Default to free user
                console.log('üìÑ User is on free plan');
                setUIToFreeUser();
                
            } catch (error) {
                console.error('‚ùå Error checking subscription status:', error);
                setUIToFreeUser(); // Default to free on error
            }
        }
        
        // Set UI to show free user
        function setUIToFreeUser() {
            const userStatus = document.getElementById('userStatus');
            const upgradeSection = document.getElementById('upgradeSection');
            const proSection = document.getElementById('proSection');
            
            if (userStatus) {
                userStatus.textContent = 'Free Plan';
                userStatus.className = 'status free';
            }
            
            if (upgradeSection) upgradeSection.classList.remove('hidden');
            if (proSection) proSection.classList.add('hidden');
            
            console.log('üÜì UI set to free user');
        }
        
        // Set UI to show Pro user
        function setUIToProUser(planName) {
            const userStatus = document.getElementById('userStatus');
            const upgradeSection = document.getElementById('upgradeSection');
            const proSection = document.getElementById('proSection');
            
            if (userStatus) {
                userStatus.textContent = `${planName} Active`;
                userStatus.className = 'status pro';
            }
            
            if (upgradeSection) upgradeSection.classList.add('hidden');
            if (proSection) proSection.classList.remove('hidden');
            
            console.log('üíé UI set to Pro user:', planName);
        }
        
        // Dummy functions for compatibility
        async function signInWithGoogle() {
            console.log('üîç Starting Google Sign-In...');
            
            if (!auth) {
                console.error('‚ùå Firebase Auth not initialized');
                alert('Firebase authentication not available. Please refresh and try again.');
                return;
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                
                console.log('‚úÖ Google Sign-In successful:', currentUser.uid);
                console.log('üë§ User email:', currentUser.email);
                
                // Create user document if it doesn't exist
                await createUserDocumentIfNeeded(currentUser);
                
                showDashboard();
                
            } catch (error) {
                console.error('‚ùå Google Sign-In failed:', error);
                alert('Google Sign-In failed: ' + error.message);
            }
        }
        
        // Create user document in Firestore if it doesn't exist
        async function createUserDocumentIfNeeded(user) {
            if (!db || !user) return;
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    console.log('üë§ Creating new user document...');
                    
                    const userData = {
                        name: user.displayName || user.email?.split('@')[0] || 'User',
                        email: user.email,
                        isPro: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        credits: 20, // Initial free credits
                        lastCreditRefresh: firebase.firestore.FieldValue.serverTimestamp(),
                        signInMethod: 'google',
                        planType: 'free'
                    };
                    
                    await db.collection('users').doc(user.uid).set(userData);
                    console.log('‚úÖ User document created successfully');
                } else {
                    console.log('‚úÖ User document already exists');
                }
            } catch (error) {
                console.error('‚ùå Error creating user document:', error);
            }
        }
        
        // Handle email/password sign up
        async function handleSignUp(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            
            if (!name || !email || !password) {
                alert('All fields are required');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            if (!auth) {
                alert('Firebase authentication not available');
                return;
            }
            
            try {
                console.log('üîç Creating user with email/password...');
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                console.log('‚úÖ User created successfully:', currentUser.uid);
                
                // Create user document
                const userData = {
                    name: name,
                    email: email,
                    isPro: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    credits: 20,
                    lastCreditRefresh: firebase.firestore.FieldValue.serverTimestamp(),
                    signInMethod: 'email',
                    planType: 'free'
                };
                
                await db.collection('users').doc(currentUser.uid).set(userData);
                console.log('‚úÖ User document created');
                
                showDashboard();
                
            } catch (error) {
                console.error('‚ùå Sign-up failed:', error);
                alert('Sign-up failed: ' + error.message);
            }
        }
        
        // Handle email/password sign in
        async function handleSignIn(event) {
            event.preventDefault();
            
            const email = document.getElementById('signinEmail').value.trim();
            const password = document.getElementById('signinPassword').value;
            
            if (!email || !password) {
                alert('Email and password are required');
                return;
            }
            
            if (!auth) {
                alert('Firebase authentication not available');
                return;
            }
            
            try {
                console.log('ÔøΩ Signing in with email/password...');
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                console.log('‚úÖ Sign-in successful:', currentUser.uid);
                
                showDashboard();
                
            } catch (error) {
                console.error('‚ùå Sign-in failed:', error);
                alert('Sign-in failed: ' + error.message);
            }
        }
        
        function signOut() {
            console.log('üîç Signing out...');
            
            if (auth && currentUser) {
                auth.signOut().then(() => {
                    console.log('‚úÖ Sign-out successful');
                    currentUser = null;
                    showAuth();
                }).catch((error) => {
                    console.error('‚ùå Sign-out failed:', error);
                });
            } else {
                currentUser = null;
                showAuth();
            }
        }
        
        // Manual refresh subscription status
        async function refreshSubscriptionStatus() {
            if (!currentUser) {
                alert('No user signed in');
                return;
            }
            
            console.log('üîÑ Manually refreshing subscription status...');
            
            // Show loading indicator
            const refreshBtn = event.target;
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = 'üîÑ Refreshing...';
            refreshBtn.disabled = true;
            
            try {
                await checkUserSubscriptionStatus(currentUser.uid);
                console.log('‚úÖ Subscription status refreshed');
            } catch (error) {
                console.error('‚ùå Error refreshing subscription:', error);
                alert('Failed to refresh subscription status');
            } finally {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }
        
        // Initialize app
        function initializeApp() {
            updateLoadingStatus('Initializing Firebase...');
            const firebaseReady = initializeFirebase();
            
            updateLoadingStatus('Setting up payment handlers...');
            setupPaymentHandlers();
            
            updateLoadingStatus('Setting up authentication...');
            setupAuthHandlers();
            setupAuthStateListener();
            
            // Test Firebase connection
            if (firebaseReady) {
                testFirebaseConnection();
            }
            
            updateLoadingStatus('Loading complete!');
            // Start with auth screen - let auth state listener handle dashboard
            setTimeout(() => {
                hideLoadingOverlay();
                // Ensure we start with auth screen regardless
                showAuth();
            }, 1000);
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            if (!db) {
                console.log('‚ö†Ô∏è Skipping Firebase test - no database connection');
                return;
            }
            
            try {
                console.log('üß™ Testing Firebase connection...');
                
                // Try to read from Firestore
                const testDoc = await db.collection('_test').doc('connection').get();
                console.log('‚úÖ Firebase connection test successful');
                
                // Try to write to Firestore
                await db.collection('_test').doc('connection').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: 'payment_portal_connection'
                });
                console.log('‚úÖ Firebase write test successful');
                
            } catch (error) {
                console.error('‚ùå Firebase connection test failed:', error);
                console.error('üîß Check Firebase rules and project configuration');
            }
        }
        
        // Load scripts
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = () => {
                console.warn(`Failed to load ${src}`);
                callback(); // Continue anyway
            };
            document.head.appendChild(script);
        }
        
        // Start loading
        updateLoadingStatus('Loading Razorpay SDK...');
        loadScript('https://checkout.razorpay.com/v1/checkout.js', () => {
            scriptsLoaded++;
            updateLoadingStatus('Razorpay SDK loaded');
            
            updateLoadingStatus('Loading Firebase SDK...');
            loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js', () => {
                loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js', () => {
                    loadScript('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js', () => {
                        scriptsLoaded++;
                        updateLoadingStatus('Firebase SDK loaded');
                        
                        if (scriptsLoaded >= 2) { // Razorpay + Firebase
                            initializeApp();
                        }
                    });
                });
            });
        });
        
        // Fallback initialization
        setTimeout(() => {
            if (document.getElementById('loadingOverlay').style.display !== 'none') {
                console.log('‚ö†Ô∏è Fallback initialization');
                initializeApp();
            }
        }, 5000);
        
        // Make functions global
        window.switchTab = switchTab;
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
        window.refreshSubscriptionStatus = refreshSubscriptionStatus;
        
        console.log('‚úÖ Payment portal script loaded');
    </script>
</body>
</html>