fun handleReturnKey() {
        performHapticFeedback()
        val ic = currentInputConnection ?: return
        val editorAction = currentEditorInfo?.imeOptions?.and(EditorInfo.IME_MASK_ACTION)

        when (editorAction) {
            EditorInfo.IME_ACTION_DONE -> {
                ic.commitText("\n", 1)
            }
            EditorInfo.IME_ACTION_GO,
            EditorInfo.IME_ACTION_SEARCH,
            EditorInfo.IME_ACTION_SEND,
            EditorInfo.IME_ACTION_NEXT -> {
                // For all other specific actions, we let the app handle it.
                ic.performEditorAction(editorAction)
            }
            else -> {
                // This is the fallback case for IME_ACTION_NONE, IME_ACTION_UNSPECIFIED, etc.
                if (currentInputTypeSupportsMultiLine) {
                    // If it's a multi-line field (like a chat box), insert a newline.
                    ic.commitText("\n", 1)
                } else {
                    // If it's a single-line field with no specific action,
                    // sending a standard Enter event is a safe default.
                    sendDownUpKeyEvents(KeyEvent.KEYCODE_ENTER)
                }
            }
        }
    }